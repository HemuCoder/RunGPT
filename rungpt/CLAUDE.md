# RunGPT æ¡†æ¶æ¶æ„æ–‡æ¡£

## æ¦‚è¿°

RunGPT æ˜¯ä¸€ä¸ªè½»é‡çº§ã€æ¨¡å—åŒ–çš„ AI Agent æ¡†æ¶,æ”¯æŒå¤šç§æ¨ç†æ¨¡å¼å’Œå·¥å…·è°ƒç”¨ã€‚

## ç›®å½•ç»“æ„

```
rungpt/
â”œâ”€â”€ agent/              # Agent å®ç°
â”‚   â”œâ”€â”€ parsers/       # è§£æå™¨ç­–ç•¥æ¨¡å¼
â”‚   â”œâ”€â”€ agent_base.py  # Agent æŠ½è±¡åŸºç±»
â”‚   â”œâ”€â”€ react_agent.py # ReAct æ¨ç† Agent
â”‚   â””â”€â”€ simple_agent.py # ç®€å•å¯¹è¯ Agent
â”œâ”€â”€ tools/             # å·¥å…·ç³»ç»Ÿ
â”‚   â”œâ”€â”€ tool.py        # å·¥å…·å®šä¹‰
â”‚   â”œâ”€â”€ registry.py    # å·¥å…·æ³¨å†Œè¡¨
â”‚   â”œâ”€â”€ result.py      # æ ‡å‡†åŒ–è¿”å›å¯¹è±¡
â”‚   â”œâ”€â”€ schema.py      # Schema æå–
â”‚   â””â”€â”€ validators.py  # å‚æ•°éªŒè¯
â”œâ”€â”€ threads/           # å¯¹è¯çº¿ç¨‹ç®¡ç†
â”‚   â”œâ”€â”€ thread.py      # å¯¹è¯çº¿ç¨‹
â”‚   â””â”€â”€ memory_manager.py # è®°å¿†ç®¡ç†
â”œâ”€â”€ workflow/          # å·¥ä½œæµå±‚
â”‚   â”œâ”€â”€ core.py        # æ ¸å¿ƒæŠ½è±¡ (Step, Context, Pipeline)
â”‚   â”œâ”€â”€ steps.py       # åŸºç¡€ Step å®ç° (AgentStep, FunctionStep)
â”‚   â””â”€â”€ patterns.py    # ç¼–æ’æ¨¡å¼ (Router, Parallel, PlanExecutePattern)
â”œâ”€â”€ models/            # æ¨¡å‹æ¥å£
â”‚   â”œâ”€â”€ model_interface.py # æ¨¡å‹æŠ½è±¡æ¥å£
â”‚   â”œâ”€â”€ unified_provider.py # ç»Ÿä¸€æ¨¡å‹æä¾›è€…
â”‚   â””â”€â”€ model_registry.py # æ¨¡å‹æ³¨å†Œè¡¨
â””â”€â”€ context/           # ä¸Šä¸‹æ–‡ç®¡ç†
    â”œâ”€â”€ context_manager.py # ä¸Šä¸‹æ–‡ç®¡ç†å™¨
    â”œâ”€â”€ prompt_template.py # æç¤ºè¯æ¨¡æ¿
    â”œâ”€â”€ tool_injector.py # å·¥å…·æ³¨å…¥å™¨
    â””â”€â”€ skill_injector.py # æŠ€èƒ½æ³¨å…¥å™¨
```

## æ ¸å¿ƒæ¨¡å—

### Workflow æ¨¡å—

**èŒè´£**: å®ç°å¤æ‚æµç¨‹ç¼–æ’ï¼Œæ›¿ä»£ä¼ªè£…æˆ Agent çš„ PlanExecuteAgent

**æ ¸å¿ƒæŠ½è±¡**:
- `Step`: æ‰€æœ‰èŠ‚ç‚¹çš„åŸºç±» (Everything is a Step)
- `WorkflowContext`: åƒæ²³æµä¸€æ ·åœ¨ Step é—´ä¼ é€’æ•°æ®
- `Pipeline`: çº¿æ€§æ‰§è¡Œå®¹å™¨ (æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ª Step)

**åŸºç¡€ç»„ä»¶**:
- `AgentStep`: å°† Agent åŒ…è£…ä¸º Step
- `FunctionStep`: å°†å‡½æ•°åŒ…è£…ä¸º Step

**ç¼–æ’æ¨¡å¼**:
- `Router`: æ¡ä»¶è·¯ç”±
- `Parallel`: å¹¶è¡Œæ‰§è¡Œ
- `PlanExecutePattern`: ä»»åŠ¡åˆ†è§£ â†’ æ‰§è¡Œ â†’ æ€»ç»“ï¼ˆæ¨èï¼‰

**è®¾è®¡å“²å­¦**:
- **ç»„åˆä¼˜äºç»§æ‰¿**: é€šè¿‡ç»„åˆç®€å• Step æ„å»ºå¤æ‚æµç¨‹
- **æ˜¾å¼æ•°æ®æµ**: é€šè¿‡ `input_key`/`output_key` æ˜¾å¼å®šä¹‰æ•°æ®æµå‘
- **æ— ä¾µå…¥æ€§**: ç°æœ‰ Agent ä»£ç æ— éœ€ä¿®æ”¹å³å¯æ¥å…¥
- **æ¸…æ™°å®šä½**: PlanExecute æ˜¯ Patternï¼Œä¸æ˜¯ Agent

**PlanExecutePattern ä¼˜åŠ¿**:
- ç”¨æˆ·è‡ªå®šä¹‰ 3 ä¸ª Agentï¼ˆplanner/executor/summarizerï¼‰
- Pattern è‡ªåŠ¨ç®¡ç† JSON è§£æå’Œä¾èµ–å…³ç³»
- å¯ç»„åˆ: ä½œä¸º Step å¯ä»¥åµŒå¥—åœ¨å…¶ä»– Workflow ä¸­
- èŒè´£æ¸…æ™°: System Prompt å®šä¹‰è§’è‰²ï¼ŒUser Prompt å®šä¹‰æ ¼å¼

### Agent æ¨¡å—

**èŒè´£**: å®ç°ä¸åŒæ¨ç†æ¨¡å¼çš„ AI Agent

**å…³é”®è®¾è®¡**:
- `AgentBase`: æŠ½è±¡åŸºç±»,å®šä¹‰ Agent é€šç”¨æ¥å£
- ç­–ç•¥æ¨¡å¼: ä¸åŒ Agent å®ç°ä¸åŒæ¨ç†ç­–ç•¥
- æ¨¡æ¿æ–¹æ³•: `_execute` ç”±å­ç±»å®ç°å…·ä½“é€»è¾‘

**æ¨ç†æ¨¡å¼**:
- `SimpleAgent`: å•è½®å¯¹è¯,æ— å·¥å…·è°ƒç”¨
- `ReActAgent`: Think â†’ Act â†’ Observe å¾ªç¯,æ”¯æŒå·¥å…·è°ƒç”¨

**å¤æ‚ä»»åŠ¡ç¼–æ’**: ä½¿ç”¨ Workflow æ¨¡å¼ç»„åˆå¤šä¸ª Agent

**æœ€è¿‘ä¼˜åŒ–**:
- **åˆ é™¤ PlanExecuteAgent (v0.2.1, 2025-11-28)**: å®ç”¨ä¸»ä¹‰çš„èƒœåˆ©
  - âœ… åˆ é™¤ `PlanExecuteAgent`: ä¼ªè£…çš„ Workflowï¼Œåº”è¯¥ç”¨çœŸæ­£çš„ Workflow å®ç°
  - è®¾è®¡å“²å­¦: å¤æ‚ä»»åŠ¡ç¼–æ’åº”è¯¥ç”¨ Workflow æ¨¡å¼ï¼Œè€Œéä¼ªè£…æˆ"å• Agent"
- **åˆ é™¤ç»“æ„åŒ–è¾“å‡ºè¿‡åº¦è®¾è®¡**: å®ç”¨ä¸»ä¹‰çš„èƒœåˆ©
  - âœ… åˆ é™¤ `structured_output.py`: ç§»é™¤å¼ºåˆ¶ JSON Schema æ³¨å…¥é€»è¾‘
  - âœ… åˆ é™¤ `response_model` å‚æ•°: Agent.run() åªè¿”å›å­—ç¬¦ä¸²
  - è®¾è®¡å“²å­¦: æ¡†æ¶ä¸æ›¿ç”¨æˆ·åšä¸»ï¼Œå¦‚æœéœ€è¦ç»“æ„åŒ–è¾“å‡ºåœ¨ prompt ä¸­è¯´æ˜
- ReActAgent æ–¹æ³•æ‹†åˆ†: `_execute` â†’ `_execute_step`, `_handle_action`, `_handle_finish`, `_handle_error`, `_force_finish`
- è§£æå™¨é‡æ„: ä» 279 è¡Œå•æ–‡ä»¶é‡æ„ä¸ºç­–ç•¥æ¨¡å¼,4 ä¸ªä¸“ç”¨è§£æå™¨ + ç®¡ç†å™¨

### è§£æå™¨æ¨¡å— (`agent/parsers/`)

**èŒè´£**: è§£æ LLM è¾“å‡º,æå–ç»“æ„åŒ– Action

**æ¶æ„**: ç­–ç•¥æ¨¡å¼
- `ParserStrategy`: æŠ½è±¡åŸºç±»
- `BracketFormatParser`: å¤„ç† `tool[params]` æ ¼å¼
- `FunctionCallParser`: å¤„ç† `tool(params)` æ ¼å¼
- `JSONActionParser`: å¤„ç† JSON ä»£ç å—
- `RobustActionParser`: æ¨¡ç³ŠåŒ¹é…å’Œä¿®å¤(å…œåº•)
- `ParserManager`: ç­–ç•¥ç¼–æ’å™¨,æŒ‰ä¼˜å…ˆçº§å°è¯•

**ä¼˜åŠ¿**:
- å¼€é—­åŸåˆ™: æ–°å¢æ ¼å¼åªéœ€æ·»åŠ æ–°ç­–ç•¥
- å•ä¸€èŒè´£: æ¯ä¸ªè§£æå™¨ä¸“æ³¨ä¸€ç§æ ¼å¼
- å¯æµ‹è¯•æ€§: ç‹¬ç«‹æµ‹è¯•æ¯ä¸ªç­–ç•¥

### å·¥å…·æ¨¡å—

**èŒè´£**: å·¥å…·å®šä¹‰ã€æ³¨å†Œã€è°ƒç”¨ã€éªŒè¯

**å…³é”®ç»„ä»¶**:
- `Tool`: å·¥å…·å®šä¹‰,æ”¯æŒ Pydantic éªŒè¯
- `ToolRegistry`: å·¥å…·æ³¨å†Œè¡¨,æ”¯æŒè£…é¥°å™¨æ³¨å†Œ
- `ToolResult`: æ ‡å‡†åŒ–è¿”å›å¯¹è±¡ (å¼ºåˆ¶ä½¿ç”¨)
- `schema.py`: è‡ªåŠ¨æå–å‡½æ•°ç­¾å

**æœ€è¿‘ä¼˜åŒ–**:
- å¼ºåˆ¶ ToolResult: ç§»é™¤è‡ªåŠ¨åŒ…è£…é€»è¾‘,æ‰€æœ‰å·¥å…·å¿…é¡»è¿”å› `ToolResult.ok()` æˆ– `ToolResult.fail()`
- æ¶ˆé™¤ç‰¹æ®Šæƒ…å†µ: ä¸å†æœ‰ 3 å±‚ if-else åˆ¤æ–­è¿”å›å€¼ç±»å‹

### çº¿ç¨‹æ¨¡å—

**èŒè´£**: ç®¡ç†å¯¹è¯å†å²å’Œä¸Šä¸‹æ–‡

**è®¾è®¡**:
- è½»é‡çº§: ä»…ç»´æŠ¤æ¶ˆæ¯åˆ—è¡¨,ä¸ä¾èµ–å¤–éƒ¨å­˜å‚¨
- çµæ´»æ€§: æ”¯æŒå…ƒæ•°æ®å­˜å‚¨
- åºåˆ—åŒ–: å¯å¯¼å‡º/æ¢å¤ä¸ºå­—å…¸

### æ¨¡å‹æ¨¡å—

**èŒè´£**: ç»Ÿä¸€ä¸åŒ LLM æä¾›å•†çš„æ¥å£

**æ¶æ„**:
- `ModelInterface`: æŠ½è±¡æ¥å£
- `UnifiedProvider`: ç»Ÿä¸€å®ç°,æ”¯æŒ OpenAI/Anthropic/Google ç­‰
- `ModelRegistry`: æ¨¡å‹æ³¨å†Œè¡¨

## è®¾è®¡åŸåˆ™

### 1. æ¶ˆé™¤ç‰¹æ®Šæƒ…å†µ
- âŒ å: å¤šä¸ª if-else å¤„ç†è¾¹ç•Œæƒ…å†µ
- âœ… å¥½: é€šè¿‡è®¾è®¡è®©è¾¹ç•Œè‡ªç„¶èå…¥å¸¸è§„

### 2. å®ç”¨ä¸»ä¹‰
- å…ˆå†™æœ€ç®€å•èƒ½è¿è¡Œçš„å®ç°
- é¿å…è¿‡åº¦å·¥ç¨‹å’Œç†è®ºå®Œç¾

### 3. ç®€æ´æ€§
- å‡½æ•°ä¸è¶…è¿‡ 20 è¡Œ
- ä¸è¶…è¿‡ 3 å±‚ç¼©è¿›
- æ–‡ä»¶ä¸è¶…è¿‡ 800 è¡Œ

### 4. å•ä¸€èŒè´£
- æ¯ä¸ªç±»/å‡½æ•°åªåšä¸€ä»¶äº‹
- é«˜å†…èš,ä½è€¦åˆ

## æœ€è¿‘é‡æ„æ€»ç»“

### P0 æ¶æ„çº§ä¼˜åŒ– âœ…
1. **åˆ é™¤ç»“æ„åŒ–è¾“å‡ºè¿‡åº¦è®¾è®¡ (2025-11-28)**: å®ç”¨ä¸»ä¹‰çš„èƒœåˆ©
   - åˆ é™¤ structured_output.py åŠæ‰€æœ‰ç›¸å…³é€»è¾‘
   - åˆ é™¤ response_model å‚æ•°
   - æ¡†æ¶åªè¿”å›å­—ç¬¦ä¸²ï¼Œä¸åšå‡è®¾
2. **è§£æå™¨ç­–ç•¥æ¨¡å¼**: 279 è¡Œ â†’ 72 è¡Œä¸»æ–‡ä»¶ + 5 ä¸ªç­–ç•¥ç±»
3. **Agent æ–¹æ³•æ‹†åˆ†**: 164 è¡Œ `_execute` â†’ 5 ä¸ªèŒè´£å•ä¸€çš„æ–¹æ³•
4. **ToolResult å¼ºåˆ¶**: ç§»é™¤è‡ªåŠ¨åŒ…è£…,ç»Ÿä¸€è¿”å›ç±»å‹

### P1 ä»£ç è´¨é‡ ğŸ”„
1. **æ¶ˆé™¤é‡å¤**: åˆå¹¶ `parser_utils.py` åˆ°ç­–ç•¥æ¨¡å¼ âœ…
2. **ç®€åŒ–ç±»å‹æ˜ å°„**: å¾…ä¼˜åŒ–
3. **å‚æ•°å¯¹è±¡åŒ–**: å¾…ä¼˜åŒ–

### P2 å·¥ç¨‹å®è·µ ğŸ”„
1. **æ¶æ„æ–‡æ¡£**: æœ¬æ–‡ä»¶
2. **æ–‡ä»¶ç»„ç»‡**: åˆ›å»º `parsers/` å­æ¨¡å— âœ…
3. **è¿ç§»æŒ‡å—**: å¾…åˆ›å»º

## è¿ç§»æŒ‡å—

### å·¥å…·å‡½æ•°è¿ç§»

**æ—§ç‰ˆæœ¬**:
```python
def my_tool(param: str) -> str:
    return "result"
```

**æ–°ç‰ˆæœ¬**:
```python
from rungpt.tools import ToolResult

def my_tool(param: str) -> ToolResult:
    return ToolResult.ok("result")
    # æˆ–é”™è¯¯æƒ…å†µ
    # return ToolResult.fail("error message")
```

### è§£æå™¨ä½¿ç”¨

**æ—§ç‰ˆæœ¬**:
```python
from rungpt.agent.react_parser import ReActParser
parser = ReActParser()
action = parser.parse(text)
```

**æ–°ç‰ˆæœ¬** (å‘åå…¼å®¹):
```python
from rungpt.agent.react_parser import ReActParser
parser = ReActParser()
action = parser.parse(text)  # å†…éƒ¨ä½¿ç”¨ç­–ç•¥æ¨¡å¼
```

---

**ç»´æŠ¤è€…**: RunGPT Team  
**æœ€åæ›´æ–°**: 2025-11-27  
**ç‰ˆæœ¬**: 2.0 (ç­–ç•¥æ¨¡å¼é‡æ„ç‰ˆ)
